name: Build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  find-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      archive_results: ${{ steps.filter.outputs.archive_results }}
      site: ${{ steps.filter.outputs.site }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: '1'
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            archive_results:
              - '.github/workflows/*.yml'
              - 'results/**'
            site:
              - '.github/workflows/*.yml'
              - '.github/scripts/**'
              - '.github/site/**'
              - 'results/**'
            scripts:
              - '.github/workflows/*.yml'
              - 'compare.py'
              - 'execute.py'

  ImportResults:
    needs: [ find-changes ]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
        (
          (needs.find-changes.outputs.site == 'true' || needs.find-changes.outputs.archive_results == 'true') &&
            github.ref == 'refs/heads/main' &&
            github.event_name == 'push'
        )
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch
      - uses: actions/checkout@v4
        with:
          ref: github_pages
          path: github-pages-branch
      - name: Sync site scripts
        run: |
          mkdir -p github-pages-branch/.github/scripts
          rsync -avz main-branch/.github/scripts/ github-pages-branch/.github/scripts/
      - name: Sync Results
        run: |
          mkdir -p github-pages-branch/results
          rsync -avz main-branch/results/ github-pages-branch/results/
      - name: Prepare artifact
        run: |
          cd github-pages-branch
          git add .github/scripts/
          git add results/
          
          # Identify changed files (cached diff)
          CHANGED_FILES=$(git diff --name-only --cached)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No changes detected."
            mkdir -p ../artifact-staging
          else
            echo "Changes detected:"
            echo "$CHANGED_FILES"
            
            # Copy changed files to artifact staging, preserving structure
            # We use rsync with --files-from to handle paths correctly
            echo "$CHANGED_FILES" > changed_files_list.txt
            mkdir -p ../artifact-staging
            rsync -av --files-from=changed_files_list.txt . ../artifact-staging/
          fi
      - name: Upload data
        uses: actions/upload-artifact@v4
        with:
          name: updated-data
          path: artifact-staging/
          retention-days: 1

  FindDirs:
    needs: [ find-changes, ImportResults ]
    name: Discover directories
    runs-on: ubuntu-latest
    if: needs.ImportResults.result == 'success'
    outputs:
      dir_list: ${{ steps.get-dirs.outputs.matrix }}
      has_work: ${{ steps.get-dirs.outputs.has_work }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: github_pages
          fetch-depth: 1
      - uses: actions/download-artifact@v4
        with:
          name: updated-data
      - uses: actions/setup-python@v6
        with: { python-version: '3.12' }
      - id: get-dirs
        run: |
          DIRS=$(python3 .github/scripts/generate_missing_hw_diffs.py --print-dirs-only | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=$DIRS" >> $GITHUB_OUTPUT
          if [ "$DIRS" = "[]" ]; then
            echo "has_work=false" >> $GITHUB_OUTPUT
          else
            echo "has_work=true" >> $GITHUB_OUTPUT
          fi

  DiffAgainstHW:
    needs: [ find-changes, FindDirs ]
    name: Diff ${{ matrix.directory }}
    runs-on: ubuntu-latest
    if: needs.FindDirs.outputs.has_work == 'true'
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.FindDirs.outputs.dir_list) }}
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
        with:
          ref: github_pages
      - uses: actions/download-artifact@v4
        with:
          name: updated-data
      - uses: actions/setup-python@v6
        with: { python-version: '3.12', cache: 'pip' }
      - name: Install requirements
        run: |
          sudo apt-get update && sudo apt-get install -y perceptualdiff
          export PIP_BREAK_SYSTEM_PACKAGES=1
          pip3 install -r requirements.txt -r .github/scripts/requirements.txt
      - name: Generate diffs
        run: python3 .github/scripts/generate_missing_hw_diffs.py --only-dir "${{ matrix.directory }}"
      - name: Upload partial diffs
        uses: actions/upload-artifact@v6
        with:
          name: diffs-${{ strategy.job-index }}
          path: compare-results/
          retention-days: 1

  Publish:
    runs-on: ubuntu-latest
    needs: [ ImportResults, DiffAgainstHW ]
    if: |
      needs.ImportResults.result == 'success' && 
      (needs.DiffAgainstHW.result == 'success' || needs.DiffAgainstHW.result == 'skipped')
    permissions:
      contents: write
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: github_pages
      - uses: actions/download-artifact@v4
        with:
          name: updated-data
      - uses: actions/download-artifact@v7
        with:
          pattern: diffs-*
          path: compare-results/
          merge-multiple: true
      - uses: actions/setup-python@v6
        with: { python-version: '3.12', cache: 'pip' }
      - name: Install requirements
        run: pip3 install -r .github/scripts/requirements.txt
      - name: Generate site content
        run: |
          python3 .github/scripts/generate_results_site.py results .github/site \
            --comparison-dir compare-results \
            --base-url https://raw.githubusercontent.com/${{ github.repository }}/github_pages \
            -v
      - name: Commit and Push
        run: |
          git config --local user.email "$GITHUB_ACTOR+github-actions@users.noreply.github.com"
          git config --local user.name "$GITHUB_ACTOR via action"
          
          git add results/ .github/scripts/ compare-results/ .github/site/
          
          if git diff-index --quiet HEAD; then
            echo "No changes to commit"
          else
            git commit -m "Update results and site $GITHUB_RUN_NUMBER"
            git push
          fi
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: '.github/site'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  CleanupMain:
    needs: [ Publish ]
    runs-on: ubuntu-latest
    if: (needs.Publish.result == 'success' || needs.Publish.result == 'skipped') && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - name: Remove images from results
        run: |
          git config --local user.email "$GITHUB_ACTOR+github-actions@users.noreply.github.com"
          git config --local user.name "$GITHUB_ACTOR via action"
          
          # Find all PNG files in results/ and remove them
          find results -name "*.png" -delete
          
          # Add changes to git index
          git add -u results/
          
          # Check if there are changes to commit
          if git diff-index --quiet HEAD; then
            echo "No changes to commit"
          else
            git commit -m "Remove processed result images [skip ci]"
            git push
          fi
