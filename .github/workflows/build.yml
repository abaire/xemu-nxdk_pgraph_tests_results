name: Build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}
  cancel-in-progress: ${{ startsWith(github.ref, 'refs/pull/') }}

jobs:
  find-changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      archive_results: ${{ steps.filter.outputs.archive_results }}
      site: ${{ steps.filter.outputs.site }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: '1'
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            archive_results:
              - '.github/workflows/*.yml'
              - 'results/**'
            site:
              - '.github/workflows/*.yml'
              - '.github/scripts/**'
              - '.github/site/**'
              - 'results/**'
              - 'compare-results/**'
            scripts:
              - '.github/workflows/*.yml'
              - 'compare.py'
              - 'execute.py'

  PackageResultsArtifact:
    needs: [ find-changes ]
    name: Package newest results
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || needs.find-changes.outputs.archive_results == 'true'
    outputs:
      xemu_info: ${{ steps.archive_results.outputs.xemu_info }}
      artifact: ${{ steps.archive_results.outputs.release_archive }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: '1'
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Archive newest results
        id: archive_results
        run: |
          newest_official_result="$(python3 .github/scripts/get_latest_results_directory.py)"
          if [[ $? ]]; then
            echo "Archiving xemu results from ${newest_official_result}"
            xemu_info="${newest_official_result##results/}"
            artifact_name="${xemu_info}_results.tgz"
            tar -vczf "${artifact_name}" "${newest_official_result}" "results/known_issues.json"
            echo "xemu_info=${xemu_info}" >> $GITHUB_OUTPUT 
            echo "release_archive=${artifact_name}" >> $GITHUB_OUTPUT
          fi
      - name: Upload artifact
        if: ${{ steps.archive_results.outputs.release_archive }}
        uses: actions/upload-artifact@v6
        with:
          name: ${{ steps.archive_results.outputs.release_archive }}
          path: ${{ steps.archive_results.outputs.release_archive }}

  CreateRelease:
    needs: [ PackageResultsArtifact ]
    name: Create release
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (needs.PackageResultsArtifact.outputs.artifact != '' && github.ref == 'refs/heads/main' && github.event_name == 'push')
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ needs.PackageResultsArtifact.outputs.artifact }}
          path: .
      - name: Calculate version
        id: calculate-version
        run: |
          version="${{ needs.PackageResultsArtifact.outputs.xemu_info }}__$(date +'%Y-%m-%d_%H-%M-%S-%N')"
          echo "version=$version" >> $GITHUB_OUTPUT
      - name: Create tag
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          custom_tag: ${{ steps.calculate-version.outputs.version }}
      - name: Create release
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: ${{ steps.tag_version.outputs.new_tag }}
          name: "xemu results ${{ steps.tag_version.outputs.new_version }}"
          prerelease: false
          draft: false
          make_latest: true
          fail_on_unmatched_files: true
          files: ${{ needs.PackageResultsArtifact.outputs.artifact }}

  FindDirs:
    needs: [ find-changes ]
    name: Discover directories
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' || 
      (needs.find-changes.outputs.site == 'true' && github.ref == 'refs/heads/main' && github.event_name == 'push')
    outputs:
      dir_list: ${{ steps.get-dirs.outputs.matrix }}
      has_work: ${{ steps.get-dirs.outputs.has_work }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12' }
      - id: get-dirs
        run: |
          DIRS=$(python3 .github/scripts/generate_missing_hw_diffs.py --print-dirs-only | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=$DIRS" >> $GITHUB_OUTPUT
          if [ "$DIRS" = "[]" ]; then
            echo "has_work=false" >> $GITHUB_OUTPUT
          else
            echo "has_work=true" >> $GITHUB_OUTPUT
          fi

  DiffAgainstHW:
    needs: [ find-changes, FindDirs ]
    name: Diff ${{ matrix.directory }}
    runs-on: ubuntu-latest
    if: needs.FindDirs.outputs.has_work == 'true'
    strategy:
      fail-fast: false
      matrix:
        directory: ${{ fromJson(needs.FindDirs.outputs.dir_list) }}
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.12', cache: 'pip' }
      - name: Install requirements
        run: |
          sudo apt-get update && sudo apt-get install -y perceptualdiff
          export PIP_BREAK_SYSTEM_PACKAGES=1
          pip3 install -r requirements.txt -r .github/scripts/requirements.txt
      - name: Generate diffs
        run: python3 .github/scripts/generate_missing_hw_diffs.py --only-dir "${{ matrix.directory }}"
      - name: Upload partial diffs
        uses: actions/upload-artifact@v6
        with:
          name: diffs-${{ strategy.job-index }}
          path: compare-results/
          retention-days: 1

  CommitDiffs:
    needs: [ FindDirs, DiffAgainstHW ]
    runs-on: ubuntu-latest
    if: always() && needs.FindDirs.outputs.has_work == 'true' && needs.DiffAgainstHW.result == 'success'
    permissions:
      contents: write
    outputs:
      sha: ${{ steps.sha.outputs.new_head_commit }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: compare-results/
          pattern: diffs-*
          merge-multiple: true
      - name: Commit and Push
        run: |
          git config --local user.email "$GITHUB_ACTOR+github-actions@users.noreply.github.com"
          git config --local user.name "$GITHUB_ACTOR via action"
          git add compare-results/
          git diff-index --quiet HEAD || (git commit -m "Auto-generated hardware diffs $GITHUB_RUN_NUMBER" && git push)
      - name: get sha
        id: sha
        run: echo "new_head_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  BuildSite:
    runs-on: ubuntu-latest
    needs: [ find-changes, FindDirs, CommitDiffs ]
    if: |
      always() &&
      (needs.CommitDiffs.result == 'success' || (needs.find-changes.outputs.site == 'true' && needs.FindDirs.outputs.has_work == 'false'))
    permissions:
      contents: write
    outputs:
      sha: ${{ steps.sha.outputs.new_head_commit }}
      site_changed: ${{ steps.check-diff.outputs.changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.CommitDiffs.outputs.sha || github.sha }}
      - uses: actions/setup-python@v5
        with: { python-version: '3.12', cache: 'pip' }
      - name: Install requirements
        run: pip3 install -r .github/scripts/requirements.txt
      - name: Generate site content
        run: python3 .github/scripts/generate_results_site.py results .github/site --comparison-dir compare-results -v
      - name: Commit and check changes
        id: check-diff
        run: |
          git config --local user.email "$GITHUB_ACTOR+github-actions@users.noreply.github.com"
          git config --local user.name "$GITHUB_ACTOR via action"
          git add .github/site
          if git diff-index --quiet HEAD; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update site content $GITHUB_RUN_NUMBER"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      - name: get sha
        id: sha
        run: echo "new_head_commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  DeploySite:
    runs-on: ubuntu-latest
    needs: [ BuildSite ]
    if: needs.BuildSite.outputs.site_changed == 'true'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.BuildSite.outputs.sha }}
          fetch-depth: 1
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.github/site'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
